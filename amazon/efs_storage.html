
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Setting up EFS storage on AWS &#8212; Zero to JupyterHub with Kubernetes 0.4 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/custom.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class='prev-next-top'>
    
  <div style='clear:both;'></div>

  </div>

  
  <div class="section" id="setting-up-efs-storage-on-aws">
<span id="amazon-aws"></span><h1>Setting up EFS storage on AWS<a class="headerlink" href="#setting-up-efs-storage-on-aws" title="Permalink to this headline">¶</a></h1>
<p>ElasticFileSystem is distributed file system which speaks the NFS protocol.  It is rumored to be a GlusterFS fork behind the scenes at AWS.</p>
<p>Drawbacks:</p>
<ul class="simple">
<li>Setting permissions on persistent volumes is not nailed down in the kubernetes spec yet.  This adds some complications we will discuss later.</li>
<li>A crafty user may be able to contact the EFS server directly and read other user’s files depending on how the system is setup.</li>
</ul>
<p>Procedure:</p>
<ol class="arabic">
<li><p class="first">Setting up an EFS volume</p>
<p>Go through the EFS setup wizard in AWS (in the future this part may be scripted).  The new EFS volume must be in
the same VPC as your cluster.  This can be changed in the AWS settings after it has been created.</p>
<p>Next, create a new security group for NFS traffic (target other instances in that group).  Add a rule for incoming NFS traffic to the node security group and to the master security group.  Change the EFS volume to use that security group.</p>
<p>To verify that your EFS volume is working correctly, ssh into one of the master nodes and su to root. Next,
follow the steps on the EFS console page for mounting your NFS volume. The DNS entry may take a few minutes to show up.</p>
<p>Once the mount succeeds, unmount it and disconnect from the admin node.</p>
</li>
<li><p class="first">Configuring Kubernetes to understand your EFS volume</p>
<p>Create test_efs.yaml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>apiVersion: v1
kind: PersistentVolume
metadata:
  name: efs-persist
spec:
  capacity:
    storage: 123Gi
  accessModes:
    - ReadWriteMany
  nfs:
    server: fs-${EFS_ID}.efs.us-east-1.amazonaws.com
    path: &quot;/&quot;
</pre></div>
</div>
<p>Create test_efs_claim.yaml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kind</span><span class="p">:</span> <span class="n">PersistentVolumeClaim</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">efs</span><span class="o">-</span><span class="n">persist</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">storageClassName</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
  <span class="n">accessModes</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">ReadWriteMany</span>
  <span class="n">resources</span><span class="p">:</span>
    <span class="n">requests</span><span class="p">:</span>
      <span class="n">storage</span><span class="p">:</span> <span class="mi">11</span><span class="n">Gi</span>
</pre></div>
</div>
<p>The sizes in these files are misleading. There is no quota enforced with EFS.  In the
future we want to set the efs PersistentVolume size to something ridiculously large
like 8EiB and the PersistentVolumeClaim to 10GB.  As far as we know at the moment, these sizes don’t matter.</p>
<p>A PersistentVolume defines a service which can perform a mount inside of a container.  The
PersistentVolumeClaim is a way of reserving a portion of the PersistentVolume and potentially
locking access to it.</p>
<p>The storageClassName setting looks innocuous, but it is incredibly critical.  The only non storage
class PV in the cluster is the one we defined above.  In the future we should tag different PV’s
and use tag filters in the PVC instead of relying on a default of “”.</p>
<p>We are going to configure jupyterhub to use the same “static” claim among all of the containers.  This
means that all of our users will be using the same EFS share which should be able to scale as high as we need.</p>
<p>This part is a little different than the standard guide.  We need to create these PV’s and PVC’s in the
namespace that our app will live in. Choose a namespace (this will be the same as the namespace you will
use in the helm install step later on)</p>
<p>Run these commands to setup your namespace and storage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="n">namespace</span> <span class="o">&lt;</span><span class="n">your</span> <span class="n">namespace</span><span class="o">&gt;</span>
<span class="n">kubectl</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=&lt;</span><span class="n">your</span> <span class="n">namespace</span><span class="o">&gt;</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">test_efs</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=&lt;</span><span class="n">your</span> <span class="n">namespace</span><span class="o">&gt;</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">test_efs_claim</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>I don’t know if the PV needs to be in the namespace, but the arg does not seem to hurt anything.  The PVC must be in the namespace or stuff will break in weird ways.</p>
</li>
<li><p class="first">Configuring your application to use EFS as it’s backing storage</p>
<p>We now add the following to config.yaml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">singleuser</span><span class="p">:</span>
  <span class="n">image</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">jupyter</span><span class="o">/</span><span class="n">base</span><span class="o">-</span><span class="n">notebook</span>
    <span class="n">tag</span><span class="p">:</span> <span class="n">latest</span>
  <span class="n">storage</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;static&quot;</span>
    <span class="n">static</span><span class="p">:</span>
      <span class="n">pvcName</span><span class="p">:</span> <span class="s2">&quot;efs-persist&quot;</span>
      <span class="n">subPath</span><span class="p">:</span> <span class="s1">&#39;home/</span><span class="si">{username}</span><span class="s1">&#39;</span>
  <span class="n">extraEnv</span><span class="p">:</span>
    <span class="n">CHOWN_HOME</span><span class="p">:</span> <span class="s1">&#39;yes&#39;</span>
  <span class="n">uid</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">fsGid</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">cmd</span><span class="p">:</span> <span class="s2">&quot;start-singleuser.sh&quot;</span>
</pre></div>
</div>
<p>The image setting overrides the default pinned jh base image since it has not yet been updated
to include the CHOWN_HOME setting.  This will be fixed in Z2JH 0.7.</p>
<p>type static tells jh not to use a storage class and instead use a PVC defined below.</p>
<p>pvcName matches the claim name we specified before</p>
<p>subPath tells where on the supplied storage the mount point should be.  In this case it will
be “$EFS_ROOT/home/{username}”</p>
<p>It turns out there is a bug in jupyterhub where the default subPath does not work, and setting the
subPath to “{username}” breaks in the same way.</p>
<p>The extraEnv section set’s environmental variables before trying to start jupyterhub inside of the user’s
container.  CHOWN_HOME is needed to force the ownership change of the home directory.</p>
<p>Kubernetes is still conflicted if a uid and a gid should be passed in to change how the directory is mounted
inside of the container.  What we do for now is auto-chown the directory before jupyterhub has been started.</p>
<p>The UID/fsGID is necessary to force the container to run the start-singleuser.sh as root.  Once
start-singleuser.sh has properly changed the ownership of the directory, it su’s to the jupyterhub user.</p>
</li>
</ol>
</div>


  <div class='prev-next-bottom'>
    
  <div style='clear:both;'></div>

  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">Zero to JupyterHub with Kubernetes</a></h1>



<p class="blurb">A tutorial to help install and manage JupyterHub with Kubernetes</p>









<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<h3>Table of Contents</h3>
<p class="caption"><span class="caption-text">Step Zero: your Kubernetes cluster</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../create-k8s-cluster.html">Creating a Kubernetes Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../google/step-zero-gcp.html">Step Zero: Kubernetes on Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../microsoft/step-zero-azure.html">Step Zero: Kubernetes on Microsoft Azure Container Service (AKS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="step-zero-aws.html">Step Zero: Kubernetes on Amazon Web Services (AWS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../redhat/step-zero-openshift.html">JupyterHub on Red Hat OpenShift</a></li>
</ul>
<p class="caption"><span class="caption-text">Creating your JupyterHub</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting started with JupyterHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup-helm.html">Setting up Helm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup-jupyterhub.html">Setting up JupyterHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../turn-off.html">Turning Off JupyterHub and Computational Resources</a></li>
</ul>
<p class="caption"><span class="caption-text">Customization Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../extending-jupyterhub.html">Extending your JupyterHub setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-environment.html">Customizing the User Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-resources.html">User Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-storage.html">User storage in JupyterHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-management.html">User Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Administrator Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">The JupyterHub Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debug.html">Debugging Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimization.html">Speed and Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading.html">Upgrading your JupyterHub Kubernetes deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced.html">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cost.html">Appendix: Projecting deployment costs</a></li>
</ul>
<p class="caption"><span class="caption-text">Resources from the community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../additional-resources.html">Community-authored documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users-list.html">Zero to JupyterHub Gallery of Deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tips.html">Tips and command snippets</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">Helm Chart Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference-docs.html">Official JupyterHub and Project Jupyter Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">Tools used in a JupyterHub Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="http://github.com/jupyterhub/zero-to-jupyterhub-k8s">GitHub Repo</a></li>
    
    <li class="toctree-l1"><a href="http://github.com/jupyterhub/zero-to-jupyterhub-k8s/issues">Issue Tracker</a></li>
    
</ul>

<div class="relations">
<h3>Navigation</h3>
<ul>
  <li><a href="../index.html">Documentation Home</a><ul>
  </ul>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/amazon/efs_storage.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Project Jupyter team.
      
      |
      <a href="../_sources/amazon/efs_storage.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>